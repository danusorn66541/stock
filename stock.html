<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏±‡∏ö‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (Stock Counter)</title>
  <link rel="icon" href="data:;base64,iVBORw0KGgo=" />
  <style>
    :root{--bg:#f5f7fa;--card:#fff;--accent:#2b7be4;--danger:#e04c4c;--warn:#e09b1c}
    body{font-family:Inter, Roboto, Arial, sans-serif;background:var(--bg);padding:18px}
    h1{text-align:center;margin-bottom:12px}
    .wrap{max-width:980px;margin:0 auto}
    .card{background:var(--card);padding:18px;border-radius:12px;box-shadow:0 6px 18px rgba(15,20,30,0.06)}
    .grid{display:grid;grid-template-columns:1fr 380px;gap:18px}
    .form input,.form select{width:100%;padding:10px;margin-top:8px;border-radius:8px;border:1px solid #d0d6df}
    .form button{width:100%;padding:10px;margin-top:10px;border-radius:8px;border:none;background:var(--accent);color:white}
    .controls{display:flex;gap:8px;margin-top:8px}
    .controls select,.controls input{padding:8px;border-radius:8px;border:1px solid #d0d6df}
    #list{margin-top:12px}
    .item{display:flex;justify-content:space-between;align-items:center;padding:12px;border-radius:10px;margin-bottom:8px;background:#f6f8fb}
    .item.low{border-left:6px solid var(--warn);background:#fff8ec}
    .item.critical{border-left:6px solid var(--danger);background:#fff6f6}
    .meta{font-size:13px;color:#555}
    .btns button{margin-left:6px;padding:8px;border-radius:8px;border:none;cursor:pointer}
    .btns .danger{background:var(--danger);color:white}
    .summary{margin-top:12px;padding:12px;border-radius:8px;background:#f0fbf4}
    .logs{margin-top:12px;height:200px;overflow:auto;padding:10px;background:#0f172433;border-radius:8px;font-family:monospace;font-size:13px}
    .install{margin-top:10px}
    @media(max-width:880px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏±‡∏ö‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h1>

    <div class="card grid">
      <div>
        <div class="form">
          <h3>‡πÄ‡∏û‡∏¥‡πà‡∏° / ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
          <input id="name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤" />
          <select id="category">
            <option value="‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ">‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</option>
            <option value="‡∏≠‡∏≤‡∏´‡∏≤‡∏£">‡∏≠‡∏≤‡∏´‡∏≤‡∏£</option>
            <option value="‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÉ‡∏ä‡πâ</option>
            <option value="‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏™‡∏≥‡∏£‡∏≠‡∏á">‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏™‡∏≥‡∏£‡∏≠‡∏á</option>
          </select>
          <input id="qty" type="number" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô" />
          <input id="minStock" type="number" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô (‡πÄ‡∏ä‡πà‡∏ô 5)" />
          <input id="cost" type="number" step="0.01" placeholder="‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏ï‡πà‡∏≠‡∏ä‡∏¥‡πâ‡∏ô (‡∏ö‡∏≤‡∏ó)" />
          <input id="price" type="number" step="0.01" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢‡∏ï‡πà‡∏≠‡∏ä‡∏¥‡πâ‡∏ô (‡∏ö‡∏≤‡∏ó)" />
          <button id="addBtn" onclick="addOrUpdate()">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
        </div>

        <div style="margin-top:12px">
          <div class="controls">
            <input id="search" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤..." oninput="render()" />
            <select id="filterCategory" onchange="render()">
              <option value="all">‡∏ó‡∏∏‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</option>
            </select>
            <select id="sortBy" onchange="render()">
              <option value="name">‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏ä‡∏∑‡πà‡∏≠ (A‚ÜíZ)</option>
              <option value="qty_desc">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏°‡∏≤‡∏Å‚Üí‡∏ô‡πâ‡∏≠‡∏¢</option>
              <option value="qty_asc">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ‡∏ô‡πâ‡∏≠‡∏¢‚Üí‡∏°‡∏≤‡∏Å</option>
              <option value="value_desc">‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏™‡∏π‡∏á‚Üí‡∏ï‡πà‡∏≥</option>
              <option value="value_asc">‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏ï‡πà‡∏≥‚Üí‡∏™‡∏π‡∏á</option>
            </select>
          </div>

          <div id="list"></div>
        </div>
      </div>

      <div>
        <div class="card" style="padding:12px">
          <h3>‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏ï‡πá‡∏≠‡∏Å</h3>
          <div id="summary" class="summary">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>

          <h3 style="margin-top:12px">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß</h3>
          <div id="logs" class="logs"></div>

          <div class="install">
            <button onclick="exportCSV()">Export CSV</button>
            <button onclick="importCSV()">Import CSV</button>
            <button onclick="clearAll()" style="margin-left:6px;background:#555;color:white">‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
          </div>

          <div style="margin-top:10px">
            <button id="promptInstall" style="display:none;width:100%;padding:10px;border-radius:8px;background:#0b7a3f;color:white">‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏≠‡∏õ (Install)</button>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
  // Data model
  let products = JSON.parse(localStorage.getItem('products')) || [];
  let logs = JSON.parse(localStorage.getItem('stock_logs')) || [];
  let editIndex = null;

  // Populate filter categories
  function rebuildCategories() {
    const set = new Set(['all']);
    products.forEach(p=>set.add(p.category||'‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ'));
    const sel = document.getElementById('filterCategory');
    sel.innerHTML = '';
    Array.from(set).forEach(cat=>{
      const opt = document.createElement('option'); opt.value = cat; opt.textContent = cat==='all'? '‡∏ó‡∏∏‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà' : cat; sel.appendChild(opt);
    });
  }

  function save() {
    localStorage.setItem('products', JSON.stringify(products));
    localStorage.setItem('stock_logs', JSON.stringify(logs));
  }

  function timeNow() {
    return new Date().toLocaleString('th-TH');
  }

  function addLog(text){
    logs.unshift(`[${timeNow()}] ${text}`);
    if (logs.length>500) logs.pop();
    save(); renderLogs();
  }

  function addOrUpdate(){
    const name = document.getElementById('name').value.trim();
    const category = document.getElementById('category').value;
    const qty = parseInt(document.getElementById('qty').value);
    const minStock = parseInt(document.getElementById('minStock').value) || 0;
    const cost = parseFloat(document.getElementById('cost').value) || 0;
    const price = parseFloat(document.getElementById('price').value) || 0;

    if(!name) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤');
    if(isNaN(qty)) return alert('‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');

    if(editIndex!==null){
      const old = products[editIndex];
      products[editIndex] = {name,category,qty,minStock,cost,price};
      addLog(`‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤: ${name} (‡∏à‡∏≤‡∏Å ${old.qty} -> ${qty})`);
      editIndex = null; document.getElementById('addBtn').innerText='‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤';
    } else {
      products.push({name,category,qty,minStock,cost,price});
      addLog(`‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà: ${name} (${qty} ‡∏ä‡∏¥‡πâ‡∏ô)`);
    }
    save(); render(); clearForm();
  }

  function clearForm(){
    ['name','qty','minStock','cost','price'].forEach(id=>document.getElementById(id).value='');
  }

  function editProduct(i){
    editIndex = i; const p = products[i];
    document.getElementById('name').value = p.name;
    document.getElementById('category').value = p.category||'‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ';
    document.getElementById('qty').value = p.qty;
    document.getElementById('minStock').value = p.minStock||0;
    document.getElementById('cost').value = p.cost||0;
    document.getElementById('price').value = p.price||0;
    document.getElementById('addBtn').innerText = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç';
  }

  function changeQty(i,amount){
    const before = products[i].qty;
    products[i].qty = Math.max(0, products[i].qty + amount);
    addLog(`${amount>0? '‡πÄ‡∏û‡∏¥‡πà‡∏°':'‡∏•‡∏î'} ${Math.abs(amount)} ‡∏ä‡∏¥‡πâ‡∏ô -> ${products[i].name} (${before} ‚Üí ${products[i].qty})`);
    save(); render();
  }

  function removeProduct(i){
    if(!confirm('‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;
    const p = products.splice(i,1)[0];
    addLog(`‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤: ${p.name}`);
    save(); render();
  }

  function render(){
    rebuildCategories();
    const list = document.getElementById('list');
    const search = document.getElementById('search').value.toLowerCase();
    const filterCat = document.getElementById('filterCategory').value;
    const sortBy = document.getElementById('sortBy').value;

    let view = products.map((p,i)=>({...p,_idx:i}));
    if(filterCat!=='all') view = view.filter(v=> (v.category||'‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ')===filterCat);
    if(search) view = view.filter(v=> v.name.toLowerCase().includes(search));

    // compute value
    view.forEach(v=> v.value = (v.qty||0) * (v.cost||0));

    // sort
    if(sortBy==='name') view.sort((a,b)=>a.name.localeCompare(b.name));
    if(sortBy==='qty_desc') view.sort((a,b)=>b.qty-a.qty);
    if(sortBy==='qty_asc') view.sort((a,b)=>a.qty-b.qty);
    if(sortBy==='value_desc') view.sort((a,b)=>b.value-a.value);
    if(sortBy==='value_asc') view.sort((a,b)=>a.value-b.value);

    let html=''; let totalItems=0; let totalValue=0; let totalCost=0;
    view.forEach(v=>{
      totalItems += v.qty||0; totalValue += (v.qty||0)*(v.price||0); totalCost += (v.qty||0)*(v.cost||0);
      const cls = (v.minStock && v.qty<=v.minStock) ? (v.qty===0? 'critical' : 'low') : '';
      html += `<div class="item ${cls}">`+
              `<div>
                <strong>${escapeHtml(v.name)}</strong> <span class="meta">[${v.category||'‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ'}]</span><br>
                <span class="meta">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: ${v.qty} | ‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô: ${formatMoney(v.cost)} | ‡∏£‡∏≤‡∏Ñ‡∏≤: ${formatMoney(v.price)} | ‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤: ${formatMoney((v.qty||0)*(v.cost||0))}</span>
              </div>`+
              `<div class="btns">
                ${v.minStock? `<span title="Minimum stock">‚ö†<small>${v.minStock}</small></span>` : ''}
                <button onclick="changeQty(${v._idx},1)">+</button>
                <button onclick="changeQty(${v._idx},-1)">-</button>
                <button onclick="editProduct(${v._idx})">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                <button class="danger" onclick="removeProduct(${v._idx})">‡∏•‡∏ö</button>
              </div>`+
             `</div>`;
    });
    list.innerHTML = html || '<div style="padding:12px;color:#666">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>';

    document.getElementById('summary').innerHTML = `
      üì¶ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏£‡∏ß‡∏°: <b>${totalItems}</b> ‡∏ä‡∏¥‡πâ‡∏ô<br>
      üí∞ ‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏£‡∏ß‡∏° (‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢): <b>${formatMoney(totalValue)}</b> ‡∏ö‡∏≤‡∏ó<br>
      üßæ ‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏£‡∏ß‡∏°: <b>${formatMoney(totalCost)}</b> ‡∏ö‡∏≤‡∏ó<br>
      üíµ ‡∏Å‡∏≥‡πÑ‡∏£ (‡πÇ‡∏î‡∏¢‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì): <b>${formatMoney(totalValue - totalCost)}</b> ‡∏ö‡∏≤‡∏ó
    `;
  }

  function renderLogs(){
    const el = document.getElementById('logs');
    el.innerHTML = logs.map(l=>`<div>${escapeHtml(l)}</div>`).join('') || '<div style="color:#666">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</div>';
  }

  function formatMoney(n){ return Number(n||0).toLocaleString(undefined,{maximumFractionDigits:2}); }
  function escapeHtml(s){ return (s+'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

  // CSV Export/Import (basic)
  function exportCSV(){
    let csv = 'name,category,qty,minStock,cost,price\n';
    products.forEach(p=> csv += `${escapeCsv(p.name)},${escapeCsv(p.category)},${p.qty||0},${p.minStock||0},${p.cost||0},${p.price||0}\n`);
    const blob = new Blob([csv],{type:'text/csv'}); const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download='products.csv'; a.click(); URL.revokeObjectURL(url);
  }
  function escapeCsv(s){ if(s==null) return ''; return '"'+(s+'').replaceAll('"','""')+'"'; }

  function importCSV(){
    const inp = document.createElement('input'); inp.type='file'; inp.accept='.csv';
    inp.onchange = e => {
      const file = e.target.files[0]; if(!file) return;
      const reader = new FileReader();
      reader.onload = ev => {
        const text = ev.target.result; const rows = text.split(/\r?\n/).filter(r=>r.trim());
        rows.slice(1).forEach(r=>{
          const cols = parseCsvLine(r);
          if(cols.length<6) return;
          products.push({name:cols[0],category:cols[1],qty:parseInt(cols[2])||0,minStock:parseInt(cols[3])||0,cost:parseFloat(cols[4])||0,price:parseFloat(cols[5])||0});
        });
        addLog('‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ CSV'); save(); render();
      };
      reader.readAsText(file,'UTF-8');
    };
    inp.click();
  }
  function parseCsvLine(line){
    // very simple CSV parse supporting quoted fields
    const out=[]; let cur=''; let inQ=false; for(let i=0;i<line.length;i++){const ch=line[i]; if(inQ){ if(ch==='"' && line[i+1]==='"'){cur+='"'; i++;} else if(ch==='"'){inQ=false;} else cur+=ch;} else { if(ch===','){out.push(cur); cur='';} else if(ch==='"'){inQ=true;} else cur+=ch; }} out.push(cur); return out;
  }

  function clearAll(){ if(confirm('‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏£‡∏ß‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å)?')){ products=[]; logs=[]; save(); render(); renderLogs(); }}

  // initial render
  render(); renderLogs();

  // PWA: create and register a small service worker via blob; create manifest via blob
  // Service Worker (offline caching minimal)
  const swCode = `self.addEventListener('install', e=>{self.skipWaiting();});self.addEventListener('fetch', e=>{});`;
  try{
    const swBlob = new Blob([swCode],{type:'application/javascript'});
    const swUrl = URL.createObjectURL(swBlob);
    if('serviceWorker' in navigator){ navigator.serviceWorker.register(swUrl).catch(()=>{}); }
  } catch(e){}

  // create manifest
  const manifest = {
    name: 'Stock Counter',
    short_name: 'Stock',
    start_url: '.',
    display: 'standalone',
    background_color: '#ffffff',
    icons: [{src:'data:image/png;base64,iVBORw0KGgo=',sizes:'192x192',type:'image/png'}]
  };
  const mBlob = new Blob([JSON.stringify(manifest)],{type:'application/json'});
  const mUrl = URL.createObjectURL(mBlob);
  const link = document.createElement('link'); link.rel='manifest'; link.href=mUrl; document.head.appendChild(link);

  // handle beforeinstallprompt
  let deferredPrompt;
  window.addEventListener('beforeinstallprompt', (e)=>{
    e.preventDefault(); deferredPrompt = e; const btn = document.getElementById('promptInstall'); btn.style.display='block';
    btn.onclick = async ()=>{ deferredPrompt.prompt(); const choice = await deferredPrompt.userChoice; if(choice.outcome==='accepted'){ addLog('‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏≠‡∏õ'); } deferredPrompt = null; btn.style.display='none'; };
  });

  // small UX: highlight items that are low or critical - handled via classes in render()

  // friendly tip: autosave every 10s
  setInterval(()=> save(),10000);

</script>
</body>
</html>